<link rel="import" href="lib/bower_components/polymer/polymer.html">
<link rel="import" href="lib/bower_components/iron-ajax/iron-ajax.html">

<dom-module id="rec-result">
  <template>
    <style>
     .right { background: #b7ecb7; }
    </style>
    <iron-ajax id="request"
               method="get"
               url="recognize"
               last-response="{{response}}"
               last-error="{{err}}"></iron-ajax>
    <div class$="[[color(path,response)]]">[[resultJson(response)]]</div>
  </template>
  <script>
   Polymer({
       is: "rec-result",
       ready: function() { this.go(); },
       go: function() {
           this.response = null;
           this.$.request.params = {'path': this.path};
           this.$.request.generateRequest();

       },
       properties: {
           path: {type: String}
       },
       observers: [
           'resultJson(response)'
       ],
       resultJson: function(response) {
           if (response === null) {
               return '...';
           }
           return `${JSON.stringify(response.result)} (${response.ms} ms)`;
       },
       color: function(path, response) {
           if (response === null) {
               return '';
               }
           let word = path.split("/")[2];
           let bestMatch = response.result.split(' ')[0];
           return word == bestMatch ? 'right' : 'wrong';
       }
   });
  </script>
</dom-module>

<dom-module id="recognize-speech">
  <template>
    <style>
     table td {
         border-bottom: 1px solid #eee;
         padding: 0 8px;
     }
    </style>
    <iron-ajax id="request" method="get" url="recognize"
               last-response="{{result}}"
               last-error="{{err}}"></iron-ajax>
    <div><button on-click="onRerun">Rerun</button></div>
    <table>
      <thead>
        <tr>
          <td>input audio path</td>
          <td>latest model result</td>
          <td>previous model result</td>
        </tr>
      </thead>
      <tbody>
        <template is="dom-repeat" items="[[sounds]]">
          <tr class="resultRow">
            <td>[[wordFromPath(item)]]</td>
            <td><rec-result path="[[item]]"></rec-result></td>
            <td><!-- filled in by DOM editing --></td>
          </tr>
        </template>
      </tbody>
    </table>
  </template>
  <script>
   Polymer({
       is: "recognize-speech",
       properties: {
           result: {type: Object},
           sounds: {type: Array, value: [
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805356819.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805384231.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805398430.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805410225.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805456050.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805480864.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805491211.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805503362.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805514880.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805526988.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805537293.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/5th/1489805549510.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806733030.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806716099.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806698135.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806681162.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806766001.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806780909.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806797739.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806813936.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806831312.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806845887.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806859212.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806878042.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806900746.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/color/1489806920774.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806345279.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806374091.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806392615.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806410387.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806437045.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806448131.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806461334.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806479076.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806502267.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806527054.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806548987.webm',
               'incoming/4GGUPEPZYNahAwZpQSG6n4QIR913/friend/1489806566110.webm',
               ]}
       },
       ready: function() {
       },
       copyResultsToPrev: function() {
           this.querySelectorAll('.resultRow').forEach(function(tr) {
               var cell = tr.querySelector('td:nth-child(2)').innerText;
               tr.querySelector('td:nth-child(3)').innerText = cell;
           });
       },
       onRerun: function(ev) {
           this.copyResultsToPrev();
           this.querySelectorAll('rec-result').forEach(function(rr) {
               rr.go();
           });
       },
       wordFromPath: function(p) {
           return p.split("/")[2];
       }
   });
  </script>
</dom-module>
